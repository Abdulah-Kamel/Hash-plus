"use client"
import React, { useState } from 'react';
import { Eye, EyeOff } from 'lucide-react';
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Checkbox } from "@/components/ui/checkbox";
import {Controller,useForm} from "react-hook-form";
import {zodResolver} from "@hookform/resolvers/zod";
import * as z from "zod"
import { toast } from "sonner"
import { Field, FieldLabel, FieldDescription, FieldError } from "@/components/ui/field"
import PhoneInput, { isValidPhoneNumber, getCountryCallingCode } from 'react-phone-number-input'
import 'react-phone-number-input/style.css'
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { ChevronDown } from "lucide-react"
import { Button } from "@/components/ui/button"
import Link from "next/link";
import googleIcon from "@/assets/google-icon.svg"
import Image from "next/image";

const CustomPhoneInput = React.forwardRef(({ className, placeholder, ...props }, ref) => (
    <div className="relative flex-1">
        <Input
            name="phone"
            {...props}
            ref={ref}
            placeholder=""
            className="h-10 sm:h-12 rounded-r-none flex-1 border-r-0 text-right"
            style={{direction: "ltr"}}
        />
        {/* Custom RTL placeholder */}
        {!props.value && (
            <div
                className="absolute inset-0 flex items-center justify-end px-3 pointer-events-none text-muted-foreground"
                style={{direction: "ltr"}}
            >
                {placeholder}
            </div>
        )}
    </div>
));
CustomPhoneInput.displayName = "CustomPhoneInput";

const RegisterForm = () => {
    const [showPassword, setShowPassword] = useState(false);
    const [showConfirmPassword, setShowConfirmPassword] = useState(false);
    const [value, setValue] = useState(""); // Phone number value

    const formSchema = z.object({
        fullName: z.string().min(3, "Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„").max(255),
        email: z.string().email("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­"),
        phone: z.string().min(1, "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨"),
        password: z.string().min(8, "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„").max(255),
        confirmPassword: z.string().min(8).max(255),
        terms: z.boolean().refine(val => val === true, "ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…")
    }).refine((data) => data.password === data.confirmPassword, {
        message: "ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©",
        path: ["confirmPassword"],
    });

    const {handleSubmit, control} = useForm({
        resolver: zodResolver(formSchema),
        defaultValues: {
            fullName: '',
            email: '',
            phone: '',
            password: '',
            confirmPassword: '',
            terms: false,
        },
    })

    function onSubmit(data) {
        console.log(data)
        toast("You submitted the following values:", {
            description: (
                <pre className="bg-code text-code-foreground mt-2 w-[320px] overflow-x-auto rounded-md p-4">
                    <code>{JSON.stringify(data, null, 2)}</code>
                </pre>
            ),
            position: "bottom-right",
            classNames: {
                content: "flex flex-col gap-2",
            },
            style: {
                "--border-radius": "calc(var(--radius)  + 4px)",
            }
        })
    }

    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <div className="flex flex-col gap-6">
                {/* Full Name Field */}
                <Controller
                    name="fullName"
                    control={control}
                    render={({ field, fieldState }) => (
                        <div className="grid gap-2">
                            <Label
                                htmlFor={field.name}
                                data-invalid={fieldState.invalid}
                            >
                                Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
                            </Label>
                            <Input
                                {...field}
                                id={field.name}
                                type="text"
                                placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"
                                className="h-10 sm:h-12"
                                aria-invalid={fieldState.invalid}
                                autoComplete="name"
                            />
                            {fieldState.invalid && fieldState.error && (
                                <p className="text-sm text-red-500 mt-1">
                                    {fieldState.error.message}
                                </p>
                            )}
                        </div>
                    )}
                />

                {/* Email Field */}
                <Controller
                    name="email"
                    control={control}
                    render={({ field, fieldState }) => (
                        <div className="grid gap-2">
                            <Label
                                htmlFor={field.name}
                                data-invalid={fieldState.invalid}
                            >
                                Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†Ù‰
                            </Label>
                            <Input
                                {...field}
                                id={field.name}
                                type="email"
                                placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†Ù‰"
                                className="h-10 sm:h-12"
                                aria-invalid={fieldState.invalid}
                                autoComplete="email"
                            />
                            {fieldState.invalid && fieldState.error && (
                                <p className="text-sm text-red-500 mt-1">
                                    {fieldState.error.message}
                                </p>
                            )}
                        </div>
                    )}
                />

                {/* Phone Field */}
                <Controller
                    name="phone"
                    control={control}
                    render={({ field, fieldState }) => (
                        <div className="grid gap-2">
                            <Label
                                htmlFor={field.name}
                                data-invalid={fieldState.invalid}
                            >
                                Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                            </Label>
                            <div className="flex">
                                <PhoneInput
                                    {...field}
                                    id={field.name}
                                    international={false}
                                    countryCallingCodeEditable={false}
                                    defaultCountry="SA"
                                    value={value}
                                    onChange={(phoneValue) => {
                                        setValue(phoneValue);
                                        field.onChange(phoneValue);
                                    }}
                                    placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"
                                    className="flex w-full"
                                    inputComponent={CustomPhoneInput}
                                    withCountryCallingCode={false}
                                    displayInitialValueAsLocalNumber={true}
                                    aria-invalid={fieldState.invalid}
                                    countrySelectComponent={({ value, onChange, options, ...rest }) => (
                                        <DropdownMenu>
                                            <DropdownMenuTrigger asChild>
                                                <Button
                                                    variant="outline"
                                                    className="flex items-center gap-2 h-10 sm:h-12 px-3 rounded-l-none border-l hover:bg-gray-100 min-w-[80px]"
                                                    type="button"
                                                >
                                                    <ChevronDown className="h-4 w-4" />
                                                    <span className="text-sm">
                                                        {value ? `+${getCountryCallingCode(value)}` : '+966'}
                                                    </span>
                                                </Button>
                                            </DropdownMenuTrigger>
                                            <DropdownMenuContent align="start" className="w-56">
                                                <DropdownMenuItem onClick={() => onChange('SA')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡¸ğŸ‡¦ +966 Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
                                                    </span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => onChange('AE')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡¦ğŸ‡ª +971 Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª
                                                    </span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => onChange('KW')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡°ğŸ‡¼ +965 Ø§Ù„ÙƒÙˆÙŠØª
                                                    </span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => onChange('QA')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡¶ğŸ‡¦ +974 Ù‚Ø·Ø±
                                                    </span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => onChange('BH')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡§ğŸ‡­ +973 Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†
                                                    </span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => onChange('OM')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡´ğŸ‡² +968 Ø¹Ù…Ø§Ù†
                                                    </span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => onChange('JO')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡¯ğŸ‡´ +962 Ø§Ù„Ø£Ø±Ø¯Ù†
                                                    </span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => onChange('LB')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡±ğŸ‡§ +961 Ù„Ø¨Ù†Ø§Ù†
                                                    </span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => onChange('EG')}>
                                                    <span className="flex items-center gap-2">
                                                        ğŸ‡ªğŸ‡¬ +20 Ù…ØµØ±
                                                    </span>
                                                </DropdownMenuItem>
                                            </DropdownMenuContent>
                                        </DropdownMenu>
                                    )}
                                />
                            </div>
                            {fieldState.invalid && fieldState.error && (
                                <p className="text-sm text-red-500 mt-1">
                                    {fieldState.error.message}
                                </p>
                            )}
                        </div>
                    )}
                />

                {/* Password Field */}
                <Controller
                    name="password"
                    control={control}
                    render={({ field, fieldState }) => (
                        <div className="grid gap-2">
                            <Label
                                htmlFor={field.name}
                                data-invalid={fieldState.invalid}
                            >
                                ÙƒÙ„Ù…Ù‡ Ø§Ù„Ø³Ø±
                            </Label>
                            <div className="relative">
                                <Input
                                    {...field}
                                    id={field.name}
                                    type={showPassword ? 'text' : 'password'}
                                    placeholder="ÙƒÙ„Ù…Ù‡ Ø§Ù„Ø³Ø±"
                                    className="h-10 sm:h-12 pr-10"
                                    aria-invalid={fieldState.invalid}
                                    autoComplete="new-password"
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowPassword(!showPassword)}
                                    className="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500"
                                >
                                    {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                                </button>
                            </div>
                            {fieldState.invalid && fieldState.error && (
                                <p className="text-sm text-red-500 mt-1">
                                    {fieldState.error.message}
                                </p>
                            )}
                        </div>
                    )}
                />

                {/* Confirm Password Field */}
                <Controller
                    name="confirmPassword"
                    control={control}
                    render={({ field, fieldState }) => (
                        <div className="grid gap-2">
                            <Label
                                htmlFor={field.name}
                                data-invalid={fieldState.invalid}
                            >
                                ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ù‡ Ø§Ù„Ø³Ø±
                            </Label>
                            <div className="relative">
                                <Input
                                    {...field}
                                    id={field.name}
                                    type={showConfirmPassword ? 'text' : 'password'}
                                    placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ù‡ Ø§Ù„Ø³Ø±"
                                    className="h-10 sm:h-12 pr-10"
                                    aria-invalid={fieldState.invalid}
                                    autoComplete="new-password"
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                    className="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500"
                                >
                                    {showConfirmPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                                </button>
                            </div>
                            {fieldState.invalid && fieldState.error && (
                                <p className="text-sm text-red-500 mt-1">
                                    {fieldState.error.message}
                                </p>
                            )}
                        </div>
                    )}
                />

                {/* Terms and Conditions */}
                <Controller
                    name="terms"
                    control={control}
                    render={({ field, fieldState }) => (
                        <div className="grid gap-2">
                            <div className="flex items-center space-x-2">
                                <Checkbox
                                    id={field.name}
                                    checked={field.value}
                                    onCheckedChange={field.onChange}
                                    aria-invalid={fieldState.invalid}
                                />
                                <Label
                                    htmlFor={field.name}
                                    className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                                    data-invalid={fieldState.invalid}
                                >
                                    Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…
                                </Label>
                            </div>
                            {fieldState.invalid && fieldState.error && (
                                <p className="text-sm text-red-500 mt-1">
                                    {fieldState.error.message}
                                </p>
                            )}
                        </div>
                    )}
                />

                {/* Submit Buttons */}
                <div className="flex-col gap-2">
                    <Button type="submit" className="w-full cursor-pointer px-5 py-2 sm:py-6 rounded-lg max-sm:text-xs">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                    </Button>
                    <Button variant="outline" className="w-full cursor-pointer px-5 py-2 sm:py-6 rounded-lg mt-2 max-sm:text-xs">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¬ÙˆØ¬Ù„
                        <Image src={googleIcon} alt="google logog icon" className="h-5 w-5"/>
                    </Button>
                    <div className="mt-3 max-sm:text-xs text-center mt-6 font-light">
                        Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ
                        <Link href="/login" className="ms-2 text-primary hover:underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</Link>
                    </div>
                </div>
            </div>
        </form>
    );
};

export default RegisterForm;